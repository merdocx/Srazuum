# Техническое задание: Админ-панель Srazuum

**Версия:** 1.1  
**Дата:** 2026-01-03  
**Проект:** Srazuum  
**Домен:** srazuum.ru  
**Сервер:** 192.144.59.128  
**Статус:** Утверждено

---

## 1. Общее описание

### 1.1. Назначение
Веб-админ-панель Srazuum для управления сервисом кросспостинга из Telegram в MAX, мониторинга работы системы и просмотра статистики.

### 1.2. Целевая аудитория
- Администраторы системы
- Операторы поддержки
- Разработчики (для отладки)

### 1.3. Технические требования
- **HTTPS** с автоматическим продлением сертификата (Let's Encrypt)
- **Аутентификация** через логин/пароль или токен
- **Адаптивный дизайн** (работа на десктопе и планшете)
- **REST API** для интеграции с существующим сервисом
- **Минимальные требования к производительности** (легковесное решение)

---

## 2. Функциональные требования

### 2.1. Аутентификация и авторизация

#### 2.1.1. Вход в систему
- Страница входа с формой: логин/пароль
- Хранение хэшей паролей (bcrypt/argon2)
- Сессионные токены или JWT
- Защита от брутфорса (rate limiting)
- Возможность "Запомнить меня"

#### 2.1.2. Роли и права
- **Администратор** - полный доступ ко всем функциям (единственная роль)

### 2.2. Главная страница (Dashboard)

#### 2.2.1. Статус сервисов
- Статус сервисов systemd (только просмотр):
  - `crossposting-bot.service` (Telegram Bot Handler)
  - `crossposting-mtproto.service` (MTProto Receiver)
  - `crossposting-backup.service` (Database Backup)
  - `crossposting-backup.timer` (Backup Timer)
- Время работы (uptime)
- Последние ошибки/предупреждения
- Обновление статуса в реальном времени через WebSocket

#### 2.2.2. Общая статистика
- Количество пользователей
- Количество активных связей кросспостинга
- Количество каналов (Telegram + MAX)
- Статистика сообщений за период:
  - Всего отправлено
  - Успешно
  - С ошибками
  - В процессе
- График отправки сообщений (за последние 24 часа, 7 дней, 30 дней)
- Топ каналов по активности

#### 2.2.3. Системные метрики
- Использование памяти
- Использование CPU
- Использование диска
- Статус базы данных (подключение)
- Статус Redis (подключение)

### 2.3. Управление пользователями

#### 2.3.1. Список пользователей
- Таблица с колонками:
  - ID
  - Telegram User ID
  - Username
  - Количество каналов (Telegram + MAX)
  - Количество связей
  - Дата регистрации
  - Последняя активность
- Поиск по ID, username
- Фильтрация
- Пагинация

#### 2.3.2. Детальная информация о пользователе
- Основная информация
- Список каналов пользователя
- Список связей кросспостинга
- Статистика по сообщениям
- Логи действий (AuditLog)

### 2.4. Управление каналами

#### 2.4.1. Telegram каналы
- Список всех каналов:
  - ID
  - User ID
  - Channel ID
  - Username
  - Название
  - Статус (активен/неактивен)
  - Дата добавления
- Фильтрация по пользователю, статусу
- Поиск
- Детальная информация о канале:
  - Полная информация
  - Список связей с MAX каналами
  - Статистика сообщений

#### 2.4.2. MAX каналы
- Аналогично Telegram каналам
- Дополнительно: информация о bot_added_at

### 2.5. Управление связями кросспостинга

#### 2.5.1. Список связей
- Таблица:
  - ID
  - Пользователь
  - Telegram канал
  - MAX канал
  - Статус (включена/выключена)
  - Дата создания
  - Статистика сообщений (успешно/ошибок)
- Фильтрация по пользователю, статусу, каналам
- Поиск

#### 2.5.2. Детальная информация о связи
- Основная информация (только просмотр)
- История сообщений (MessageLog)
- Неудачные сообщения (FailedMessage)
- Статистика по периодам

### 2.6. Логи сообщений (MessageLog)

#### 2.6.1. Список логов
- Таблица:
  - ID
  - Связь кросспостинга
  - Telegram Message ID
  - MAX Message ID
  - Статус (pending/success/failed)
  - Тип сообщения
  - Размер файла
  - Время обработки
  - Дата создания
  - Ошибка (если есть)
- Фильтрация по:
  - Статусу
  - Связи
  - Типу сообщения
  - Периоду времени
- Поиск
- Обновление в реальном времени через WebSocket

#### 2.6.2. Детальная информация
- Полная информация о сообщении
- Связь с каналами
- Логи ошибок (если есть)
- Возможность повторной отправки (retry) - опционально

### 2.7. Неудачные сообщения (FailedMessage)

#### 2.7.1. Список неудачных сообщений
- Таблица с информацией об ошибках (только просмотр)
- Фильтрация по статусу (resolved/unresolved)
- Поиск
- Обновление в реальном времени через WebSocket

#### 2.7.2. Детальная информация
- Полная информация об ошибке (только просмотр)
- Количество попыток
- Последняя попытка

### 2.8. Логи аудита (AuditLog)

#### 2.8.1. История действий
- Таблица всех действий пользователей:
  - ID
  - Пользователь
  - Действие (create_link, delete_link, enable_link, disable_link)
  - Тип сущности
  - ID сущности
  - Детали (JSON)
  - Дата
- Фильтрация по пользователю, действию, периоду
- Поиск

### 2.9. Статистика и аналитика

#### 2.9.1. Общая статистика
- Графики:
  - Сообщений по дням/часам
  - Успешных vs неудачных
  - По типам сообщений
  - По каналам
- Метрики производительности:
  - Среднее время обработки
  - Средний размер файлов
  - Топ ошибок

#### 2.9.2. Статистика в реальном времени
- Обновление графиков через WebSocket
- Автообновление данных с настраиваемым интервалом

### 2.10. Настройки системы

#### 2.10.1. Параметры системы
- Просмотр основных настроек (read-only)
- Информация о конфигурации сервиса
- Статус подключений (БД, Redis)

#### 2.10.2. Управление бэкапами
- Список бэкапов БД (только просмотр)
- Скачивание бэкапов
- Информация о расписании бэкапов

#### 2.10.3. Логи системы
- Просмотр системных логов (journalctl, только чтение)
- Фильтрация по уровню, сервису, периоду
- Поиск

---

## 3. Технические требования

### 3.1. Технологический стек (рекомендуемое решение)

#### Выбранный стек:
- **Backend:** FastAPI (Python) 
  - Отличная интеграция с существующей БД (SQLAlchemy async)
  - Нативная поддержка WebSocket
  - Асинхронная обработка запросов
  - Автоматическая документация API (Swagger/OpenAPI)
  - Использование существующих моделей и настроек
  
- **Frontend:** React + TypeScript
  - Современный, популярный фреймворк
  - Богатая экосистема библиотек
  - Хорошая поддержка WebSocket клиентов
  - Компонентный подход для переиспользования
  
- **Графики:** Recharts (для React)
  - Легкая и простая в использовании
  - Хорошая документация
  - Адаптивные графики
  - Поддержка реального времени
  
- **WebSocket:** 
  - Backend: FastAPI WebSocket endpoints
  - Frontend: native WebSocket API или библиотека (например, socket.io-client)
  
- **Аутентификация:** JWT токены
  - Безопасное хранение сессий
  - Stateless аутентификация
  
- **База данных:** 
  - Использовать существующую PostgreSQL (read-only для данных, отдельные таблицы для админов)
  - Использование существующих SQLAlchemy моделей
  
- **Веб-сервер:** Nginx (reverse proxy)
  - Проксирование запросов к FastAPI
  - Статические файлы фронтенда
  - WebSocket proxy
  
- **HTTPS:** Let's Encrypt (Certbot)
  - Автоматическое получение сертификата
  - Автоматическое продление
  
- **Дополнительные библиотеки (Backend):**
  - `python-jose[cryptography]` - JWT токены
  - `passlib[bcrypt]` - хэширование паролей
  - `python-multipart` - для работы с формами (если потребуется)
  - `redis` - для кэширования (уже используется в проекте)
  
- **Дополнительные библиотеки (Frontend):**
  - `recharts` - графики и диаграммы
  - `axios` или `fetch` - HTTP клиент для API запросов
  - `react-router-dom` - маршрутизация
  - `zustand` или `react-query` - управление состоянием и кэшированием
  - `react-hook-form` - работа с формами
  - `date-fns` или `dayjs` - работа с датами
  - UI библиотека (на выбор):
    - `ant-design` - полнофункциональный набор компонентов
    - `mui` (Material-UI) - популярная библиотека компонентов
    - `chakra-ui` - простая и современная
    - Или собственные компоненты с `tailwindcss`

### 3.2. Рекомендации по реализации

#### 3.2.1. Структура проекта
```
admin_panel/
├── backend/                 # FastAPI приложение
│   ├── app/
│   │   ├── api/            # API endpoints
│   │   │   ├── auth.py     # Аутентификация
│   │   │   ├── users.py    # Пользователи
│   │   │   ├── channels.py # Каналы
│   │   │   ├── links.py    # Связи
│   │   │   ├── logs.py     # Логи
│   │   │   ├── stats.py    # Статистика
│   │   │   └── system.py   # Система
│   │   ├── core/           # Основная логика
│   │   │   ├── security.py # JWT, пароли
│   │   │   ├── database.py # Подключение к БД
│   │   │   └── websocket.py # WebSocket handlers
│   │   ├── models/         # SQLAlchemy модели (админы)
│   │   └── schemas/        # Pydantic схемы
│   ├── requirements.txt
│   └── main.py
│
├── frontend/               # React приложение
│   ├── src/
│   │   ├── components/     # React компоненты
│   │   ├── pages/          # Страницы
│   │   ├── hooks/          # Custom hooks
│   │   ├── services/       # API клиенты
│   │   ├── stores/         # State management
│   │   ├── types/          # TypeScript типы
│   │   └── utils/          # Утилиты
│   ├── package.json
│   └── ...
│
└── nginx/                  # Конфигурация Nginx
    └── admin.conf
```

#### 3.2.2. Backend рекомендации
- Использовать **Dependency Injection** FastAPI для работы с БД
- Создать общие зависимости для аутентификации (`get_current_admin`)
- Использовать **Background Tasks** FastAPI для тяжелых операций (статистика)
- Кэшировать частые запросы через Redis (статус сервисов, общая статистика)
- Использовать **Pydantic** модели для валидации и сериализации
- Реализовать пагинацию через `limit` и `offset` или cursor-based
- Добавить rate limiting для API endpoints
- Логирование всех действий через структурированное логирование

#### 3.2.3. Frontend рекомендации
- Использовать **React Router** для навигации
- Реализовать защищенные маршруты (Protected Routes)
- Использовать **React Query** или **SWR** для кэширования API запросов
- Создать custom hooks для WebSocket подключений
- Использовать контекст или state management для аутентификации
- Реализовать error boundaries для обработки ошибок
- Добавить loading states и skeleton screens
- Оптимизировать bundle size (code splitting, lazy loading)

#### 3.2.4. WebSocket рекомендации
- Создать отдельный WebSocket manager на backend
- Использовать connection pooling для управления WebSocket соединениями
- Реализовать heartbeat/ping-pong для проверки соединения
- Добавить переподключение с exponential backoff на клиенте
- Использовать JSON для обмена сообщениями
- Реализовать подписки на разные каналы (stats, services, messages)
- Добавить очередь сообщений для оффлайн клиентов (опционально)

#### 3.2.5. Безопасность рекомендации
- Использовать HTTPS только (HTTP → HTTPS редирект)
- Хэшировать пароли с помощью bcrypt (cost factor 12+)
- Использовать JWT с коротким временем жизни (15-30 минут)
- Реализовать refresh tokens для обновления access tokens
- Добавить CORS настройки (только для домена srazuum.ru)
- Валидировать все входные данные
- Использовать prepared statements (SQLAlchemy делает это автоматически)
- Регулярно обновлять зависимости
- Добавить security headers (HSTS, CSP, X-Frame-Options)

#### 3.2.6. Производительность рекомендации
- Использовать индексы БД для частых запросов
- Кэшировать результаты тяжелых запросов (статистика за период)
- Использовать database connection pooling
- Реализовать lazy loading для больших списков
- Минифицировать и сжимать статические файлы
- Использовать CDN для статики (опционально)
- Мониторить производительность запросов к БД

### 3.3. Архитектура

```
┌─────────────┐
│   Browser   │
│  (React)    │
└──────┬──────┘
       │ HTTPS (443) / WSS
       ▼
┌─────────────┐
│    Nginx    │ (Reverse Proxy)
└──────┬──────┘
       │
       ├──────────► Admin Panel API (FastAPI)
       │              ├── REST API
       │              └── WebSocket
       │
       └──────────► Existing Services (Bot, MTProto)
       
┌─────────────┐
│ PostgreSQL  │ (Shared Database)
└─────────────┘
```

### 3.3. Безопасность

- HTTPS обязателен (TLS 1.2+)
- Защита от CSRF
- Защита от XSS
- Rate limiting на API
- Валидация всех входных данных
- Хэширование паролей (bcrypt/argon2)
- Безопасное хранение токенов
- Логирование всех действий админов

### 3.4. Производительность

- Кэширование статистики (Redis)
- Ленивая загрузка данных (pagination)
- Оптимизация запросов к БД (индексы)
- Минификация статических файлов
- Сжатие ответов (gzip)

### 3.5. Мониторинг

- Логирование всех действий
- Интеграция с существующей системой логирования
- Health checks для API
- Метрики производительности

---

## 4. Структура базы данных для админки

### 4.1. Новая таблица: admins
```sql
CREATE TABLE admins (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    is_active BOOLEAN DEFAULT TRUE,
    last_login TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_admins_username ON admins(username);
CREATE INDEX idx_admins_is_active ON admins(is_active);
```

### 4.2. Новая таблица: admin_sessions (для JWT или сессий)
```sql
CREATE TABLE admin_sessions (
    id BIGSERIAL PRIMARY KEY,
    admin_id BIGINT REFERENCES admins(id) ON DELETE CASCADE,
    token VARCHAR(512) UNIQUE NOT NULL,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 4.3. Использование существующих таблиц
- Все существующие таблицы используются в режиме чтения
- Для записи - только через API существующего сервиса (или прямое изменение через админку с осторожностью)

---

## 5. API эндпоинты (пример)

### 5.1. Аутентификация
- `POST /api/auth/login` - вход
- `POST /api/auth/logout` - выход
- `GET /api/auth/me` - информация о текущем пользователе

### 5.2. Статистика
- `GET /api/stats/dashboard` - данные для dashboard
- `GET /api/stats/users` - статистика по пользователям
- `GET /api/stats/messages` - статистика по сообщениям

### 5.3. Пользователи
- `GET /api/users` - список пользователей
- `GET /api/users/{id}` - детальная информация
- `GET /api/users/{id}/channels` - каналы пользователя
- `GET /api/users/{id}/links` - связи пользователя

### 5.4. Каналы
- `GET /api/channels/telegram` - список Telegram каналов
- `GET /api/channels/telegram/{id}` - детальная информация
- `GET /api/channels/max` - список MAX каналов
- `GET /api/channels/max/{id}` - детальная информация

### 5.5. Связи
- `GET /api/links` - список связей
- `GET /api/links/{id}` - детальная информация
- `PATCH /api/links/{id}/toggle` - включить/выключить
- `DELETE /api/links/{id}` - удалить (опционально)

### 5.6. Логи
- `GET /api/logs/messages` - логи сообщений
- `GET /api/logs/messages/{id}` - детальная информация
- `GET /api/logs/failed` - неудачные сообщения
- `GET /api/logs/audit` - логи аудита

### 5.7. Система
- `GET /api/system/status` - статус сервисов
- `GET /api/system/backups` - список бэкапов
- `GET /api/system/logs` - системные логи
- `GET /api/system/metrics` - системные метрики

### 5.8. WebSocket эндпоинты
- `WS /ws/stats` - поток статистики в реальном времени
- `WS /ws/services` - поток статуса сервисов
- `WS /ws/messages` - поток новых сообщений (опционально)

---

## 6. UI/UX требования

### 6.1. Дизайн
- Современный, минималистичный дизайн
- Темная/светлая тема (опционально)
- Адаптивная верстка
- Использование иконок для визуализации

### 6.2. Навигация
- Боковое меню (sidebar) для основных разделов
- Breadcrumbs для навигации
- Поиск по всей системе (глобальный поиск)

### 6.3. Таблицы и списки
- Сортировка по колонкам
- Фильтрация
- Пагинация
- Автообновление через WebSocket

### 6.4. Формы
- Валидация на клиенте и сервере
- Понятные сообщения об ошибках
- Автосохранение (где применимо)

### 6.5. Обратная связь
- Уведомления об успешных операциях
- Уведомления об ошибках
- Индикаторы загрузки
- Подтверждения для критичных действий

---

## 7. Развертывание

### 7.1. Требования к серверу
- Сервер: 192.144.59.128
- Домен: srazuum.ru
- Операционная система: Linux
- Веб-сервер: Nginx
- HTTPS: Let's Encrypt (автоматическое продление)

### 7.2. Настройка HTTPS
- Установка Certbot
- Настройка автоматического продления
- Конфигурация Nginx для HTTPS
- Редирект HTTP → HTTPS

### 7.3. Развертывание приложения
- Установка зависимостей
- Настройка переменных окружения
- Миграции БД (создание таблиц админов)
- Настройка systemd service (опционально)
- Настройка Nginx как reverse proxy

---

## 8. Этапы разработки

### Этап 1: Базовая инфраструктура
- Настройка HTTPS
- Настройка базовой структуры проекта
- Аутентификация
- Главная страница (Dashboard) с базовой статистикой

### Этап 2: Основной функционал
- Управление пользователями
- Управление каналами
- Управление связями
- Просмотр логов сообщений

### Этап 3: Расширенный функционал
- Логи аудита
- Неудачные сообщения
- Статистика и графики
- Управление сервисами

### Этап 4: Полировка
- Улучшение UI/UX
- Оптимизация производительности
- Документация
- Тестирование

---

## 9. Ограничения и риски

### 9.1. Ограничения
- Админка не должна нарушать работу основного сервиса
- Все изменения должны быть обратимы
- Минимальная нагрузка на БД (кэширование, оптимизация)

### 9.2. Риски
- Безопасность (доступ к админке)
- Производительность (тяжелые запросы к БД)
- Совместимость с существующим кодом

---

## 10. Дополнительные возможности (будущие версии)

- Уведомления (email/Telegram) о критичных событиях
- Интеграция с системой мониторинга (Prometheus/Grafana)
- Мобильное приложение
- API для внешних интеграций
- Двухфакторная аутентификация (2FA)
- Управление сервисами (перезапуск через systemd)
- Роли и права доступа (многоролевая система)

---

## 11. Принятые решения

### 11.1. Технологический стек
**Выбрано:** FastAPI + React + TypeScript + Recharts

**Обоснование:**

- **FastAPI:**
  - Отличная интеграция с существующей Python-инфраструктурой
  - Нативная поддержка WebSocket (встроенная)
  - Async/await для асинхронной обработки
  - Автоматическая документация API (Swagger/OpenAPI)
  - Использование существующих SQLAlchemy моделей и настроек
  - Высокая производительность

- **React + TypeScript:**
  - Современный, популярный стек с большой экосистемой
  - Отличная поддержка WebSocket клиентов
  - TypeScript для типобезопасности
  - Компонентный подход для переиспользования кода
  - Широкое сообщество и документация

- **Recharts:**
  - Легкая библиотека (небольшой bundle size)
  - Отличная интеграция с React
  - Хорошая документация и примеры
  - Поддержка обновлений в реальном времени
  - Адаптивные графики из коробки
  - Альтернативы (Chart.js, D3.js) либо тяжелее, либо сложнее

### 11.2. Функциональность
- **Управление сервисами:** только просмотр статуса (без перезапуска)
- **Изменение данных:** только просмотр, без редактирования
- **Роли:** единственная роль - администратор
- **Экспорт данных:** не требуется
- **Real-time:** реализовано через WebSocket для обновления статистики, статуса сервисов и новых сообщений

