# Руководство по MTProto и получению API ID/Hash

## Что такое MTProto?

**MTProto** (Mobile Telegram Protocol) — это протокол, используемый Telegram для обмена данными между клиентами и серверами. Это **низкоуровневый протокол**, который позволяет напрямую взаимодействовать с Telegram API.

### Отличия от Bot API

| Характеристика | Bot API | MTProto (Client API) |
|----------------|---------|---------------------|
| **Тип доступа** | Через бота | Через пользовательский аккаунт |
| **Получение сообщений из каналов** | ❌ Не поддерживается | ✅ Полная поддержка |
| **Авторизация** | По токену бота | По номеру телефона + код |
| **Права доступа** | Ограничены правами бота | Полные права пользователя |
| **Сложность** | Простая | Средняя |

### Зачем нужен MTProto в нашем проекте?

**Проблема:** Telegram Bot API **не отправляет обновления** о сообщениях в каналах, где бот является администратором. Бот видит только:
- Сообщения, отправленные напрямую боту
- Обновления в группах, где бот является участником
- Но **НЕ** сообщения в каналах

**Решение:** Использовать MTProto (Client API) для получения сообщений из каналов от имени пользователя.

## Как получить API ID и API Hash?

### Шаг 1: Перейти на сайт my.telegram.org

1. Откройте в браузере: **https://my.telegram.org/apps**
2. Войдите в свой аккаунт Telegram (используйте номер телефона)

### Шаг 2: Авторизация

1. Введите свой номер телефона (с кодом страны, например: `+79991234567`)
2. Введите код подтверждения, который придет в Telegram
3. Если у вас включена двухфакторная аутентификация (2FA), введите пароль

### Шаг 3: Создание приложения

1. После входа вы увидите форму "Create new application"
2. Заполните поля:
   - **App title:** Название приложения (например: "Crossposting Service")
   - **Short name:** Короткое имя (например: "crossposting")
   - **Platform:** Выберите "Other" или "Desktop"
   - **Description:** Описание (опционально)
3. Нажмите "Create application"

### Шаг 4: Получение данных

После создания вы увидите:
- **App api_id:** Число (например: `12345678`)
- **App api_hash:** Строка (например: `abcdef1234567890abcdef1234567890`)

**⚠️ ВАЖНО:** 
- Эти данные **секретные** — не публикуйте их
- Храните их в `.env` файле
- Не коммитьте в Git

## Настройка в проекте

### 1. Добавить в .env файл

```env
TELEGRAM_API_ID=12345678
TELEGRAM_API_HASH=abcdef1234567890abcdef1234567890
TELEGRAM_PHONE=+79991234567
```

### 2. Как это работает в коде

В файле `app/mtproto/receiver.py`:

```python
from pyrogram import Client

# Создание клиента
client = Client(
    "crossposting_session",  # Имя сессии (файл будет сохранен)
    api_id=settings.telegram_api_id_int,  # API ID
    api_hash=settings.telegram_api_hash,  # API Hash
    phone_number=settings.telegram_phone  # Номер телефона
)

# Запуск клиента
await client.start()
```

### 3. Первый запуск

При первом запуске MTProto Receiver:

1. **Запросит код подтверждения:**
   ```
   Enter the code you received: 12345
   ```

2. **Если включена 2FA, запросит пароль:**
   ```
   Enter your 2FA password: your_password
   ```

3. **Создаст файл сессии:**
   - `crossposting_session.session` — файл с данными авторизации
   - Этот файл позволяет не вводить код при следующих запусках
   - **Не удаляйте этот файл!**

## Как работает MTProto в нашем проекте

### Архитектура

```
┌─────────────────┐
│  Telegram       │
│  Канал          │
└────────┬────────┘
         │
         │ (MTProto)
         ▼
┌─────────────────┐
│  Pyrogram       │
│  Client         │
│  (MTProto)      │
└────────┬────────┘
         │
         │ (on_message)
         ▼
┌─────────────────┐
│  Message        │
│  Processor      │
└────────┬────────┘
         │
         │ (MAX API)
         ▼
┌─────────────────┐
│  MAX Канал      │
└─────────────────┘
```

### Процесс работы

1. **MTProto Receiver запускается** и подключается к Telegram
2. **Загружает список отслеживаемых каналов** из базы данных
3. **Подписывается на обновления** этих каналов
4. **При получении нового сообщения:**
   - Проверяет, отслеживается ли канал
   - Пропускает служебные сообщения
   - Передает сообщение в Message Processor
5. **Message Processor:**
   - Находит активные связи для канала
   - Отправляет сообщение в MAX через API

## Безопасность

### Что хранить в секрете:

- ✅ **API ID** — можно публиковать (но лучше не нужно)
- ❌ **API Hash** — **НИКОГДА** не публикуйте
- ❌ **Файл сессии** (`.session`) — содержит токены авторизации

### Рекомендации:

1. **Добавьте в .gitignore:**
   ```
   *.session
   *.session-journal
   .env
   ```

2. **Используйте переменные окружения:**
   - Не хардкодите API ID/Hash в коде
   - Храните в `.env` файле

3. **Ограничьте доступ к файлу сессии:**
   ```bash
   chmod 600 crossposting_session.session
   ```

## Частые проблемы

### 1. "Invalid API ID"

**Причина:** Неверный API ID

**Решение:**
- Проверьте, что API ID — это число
- Убедитесь, что скопировали правильный ID с my.telegram.org

### 2. "Invalid API Hash"

**Причина:** Неверный API Hash

**Решение:**
- Проверьте, что скопировали весь hash (обычно 32 символа)
- Убедитесь, что нет лишних пробелов

### 3. "Phone number invalid"

**Причина:** Неверный формат номера

**Решение:**
- Используйте формат: `+79991234567` (с кодом страны и знаком +)
- Без пробелов и скобок

### 4. "Session expired"

**Причина:** Файл сессии поврежден или устарел

**Решение:**
- Удалите файл `crossposting_session.session`
- Перезапустите приложение (потребуется повторная авторизация)

### 5. "Flood wait"

**Причина:** Слишком много запросов к API

**Решение:**
- Подождите указанное время
- Уменьшите частоту запросов
- Используйте задержки между запросами

## Альтернативы MTProto

Если по каким-то причинам MTProto не подходит, есть альтернативы:

### 1. Пересылка сообщений (Forward)

**Как работает:**
- Пользователь пересылает сообщения боту
- Бот обрабатывает пересланные сообщения

**Плюсы:**
- Не требует MTProto
- Проще в реализации

**Минусы:**
- Не автоматически
- Требует ручных действий пользователя

### 2. Telegram Client API через другие библиотеки

- **Telethon** — альтернатива Pyrogram
- **python-telegram-bot** с расширениями

## Полезные ссылки

- **my.telegram.org/apps** — получение API ID/Hash
- **Pyrogram Documentation** — https://docs.pyrogram.org/
- **Telegram API Documentation** — https://core.telegram.org/api
- **MTProto Protocol** — https://core.telegram.org/mtproto

## Пример использования в коде

```python
from pyrogram import Client, filters
from pyrogram.handlers import MessageHandler

# Создание клиента
app = Client(
    "my_session",
    api_id=12345678,
    api_hash="your_api_hash",
    phone_number="+79991234567"
)

# Обработчик сообщений
async def on_message(client, message):
    print(f"Получено сообщение: {message.text}")

# Добавление обработчика
app.add_handler(MessageHandler(on_message, filters.channel))

# Запуск
app.run()
```

## Итоги

1. **MTProto необходим** для автоматического получения сообщений из Telegram каналов
2. **API ID/Hash получаются** на https://my.telegram.org/apps
3. **При первом запуске** потребуется авторизация (код из Telegram)
4. **Файл сессии** сохраняет авторизацию для последующих запусков
5. **Безопасность:** Храните API Hash и файл сессии в секрете




